<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pico AutoInput Editor v6</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<style>
    /* --- Base & Layout --- */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Meiryo", sans-serif; background-color: #f0f0f0; overflow: hidden; }
    #container { display: flex; width: 100%; height: 100%; box-sizing: border-box; }
    
    /* --- Left Pane: Editor --- */
    #editor-pane { 
        width: 55%; 
        height: 100%;
        display: flex; 
        flex-direction: column; 
        background-color: #fff; 
        border-right: 1px solid #ccc;
    }
    
    /* Toolbar Area */
    #toolbar { 
        padding: 8px; 
        background: #eee; 
        border-bottom: 1px solid #ccc; 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        flex-shrink: 0; 
    }
    .tool-btn { padding: 5px 12px; cursor: pointer; border: 1px solid #999; background: #fff; border-radius: 3px; font-size: 0.9rem; transition: background 0.1s;}
    .tool-btn:hover { background: #e6f7ff; border-color: #1890ff; }
    .toggle-label { font-size: 0.9rem; user-select: none; display: flex; align-items: center; gap: 5px; cursor: pointer; }
    
    #status-area { 
        padding: 4px 8px; 
        font-size: 0.85rem; 
        color: #333; 
        background: #fafafa;
        border-bottom: 1px solid #ddd;
        flex-shrink: 0; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
    }

    /* Editor Wrapper */
    #editor-wrapper {
        position: relative;
        flex-grow: 1;
        width: 100%;
        height: 0; /* Important for flex child to scroll */
        background-color: #fafafa;
        overflow: hidden;
    }

    /* Editor Layers */
    .editor-layer {
        position: absolute;
        top: 0; 
        left: 0;
        width: 100%; 
        height: 100%;
        padding: 10px;
        box-sizing: border-box;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre;
        overflow: auto;
        border: none;
        margin: 0;
    }

    #code-highlight {
        z-index: 1;
        color: transparent; 
        pointer-events: none; 
    }

    #code-input {
        z-index: 2;
        color: transparent; 
        background: transparent;
        caret-color: black; 
        outline: none;
        resize: none;
    }
    #code-input::selection { background: rgba(0, 120, 215, 0.3); color: transparent; }

    /* --- Syntax Highlighting --- */
    .line { display: block; min-height: 1.5em; }
    
    .func { color: #008000; font-weight: bold; } 
    .var  { color: #a52a2a; font-weight: bold; } 
    .arg  { color: #d4a017; }                    
    .other{ color: #0000ff; }                    
    .label-def, .label-ref { color: #a52a2a; font-weight: bold; text-decoration: underline; }

    /* Parenthesis Match Style */
    .paren-match { 
        border-bottom: 2px solid #008000; 
        background-color: rgba(0, 255, 0, 0.1);
    }

    /* Errors/Warnings */
    body.show-errors .error-bg { background-color: #ffcccc; }
    body.show-errors .warning-bg { background-color: #fff8c4; }
    
    .msg-text { font-size: 0.8em; font-weight: bold; margin-left: 10px; padding: 0 4px; border-radius: 2px; background: rgba(255,255,255,0.9); vertical-align: middle; }
    .err-text { color: red; display: none; }
    .warn-text { color: #e6a800; display: none; }

    body.show-errors .err-text { display: inline; }
    body.show-errors .warn-text { display: inline; }

    /* --- Autocomplete Popup --- */
    #autocomplete-list {
        position: absolute;
        border: 1px solid #ccc;
        background: #fff;
        z-index: 100;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 3px 3px 5px rgba(0,0,0,0.2);
        display: none;
        font-size: 12px;
        font-family: "Meiryo", sans-serif;
    }
    .ac-item { padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    .ac-item:hover, .ac-item.selected { background-color: #e6f7ff; color: #1890ff; }
    .ac-match { font-weight: bold; color: #008000; }
    .ac-type { float: right; color: #888; font-size: 0.8em; margin-left: 10px; }

    /* --- Right Pane --- */
    #info-pane { 
        width: 45%; 
        height: 100%;
        display: flex; 
        flex-direction: column; 
        background-color: #f9f9f9; 
        border-left: 1px solid #ddd; 
    }
    
    .tab-bar { 
        display: flex; 
        background: #eee; 
        border-bottom: 1px solid #ccc; 
        flex-shrink: 0; 
    }
    .tab { padding: 10px 15px; cursor: pointer; border-right: 1px solid #ccc; background: #eee; font-size: 0.9rem; }
    .tab:hover { background: #ddd; }
    .tab.active { background: #fff; font-weight: bold; border-bottom: 1px solid #fff; margin-bottom: -1px; }
    
    .tab-content { display: none; flex-grow: 1; overflow-y: auto; padding: 15px; }
    .tab-content.active { display: block; }

    /* Reference Items */
    .doc-section { margin-bottom: 20px; }
    .doc-item { margin-bottom: 6px; padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; background: #fff; border-radius: 4px; }
    .doc-item:hover { background-color: #e6f7ff; border-left: 4px solid #1890ff; padding-left: 2px; }
    .doc-syntax { font-family: monospace; font-weight: bold; color: #008000; background-color: #e8f5e9; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 2px;}
    .doc-desc { margin-left: 0px; font-size: 0.85rem; color: #555; line-height: 1.4; }
    
    h2 { font-size: 1.0rem; background: #eef; padding: 8px; border-left: 5px solid #0078d7; margin-top: 0; margin-bottom: 10px; border-radius: 2px; }
    
    /* Structure List */
    .struct-item { padding: 5px 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9rem; background: #fff;}
    .struct-item:hover { background-color: #e0f7fa; }
    .struct-name { font-weight: bold; color: #001080; }

    /* Mermaid */
    #mermaid-container { text-align: center; padding: 10px; }

    /* --- Welcome Modal --- */
    #help-modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; top: 0; 
        width: 100%; height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(2px);
    }
    .modal-content {
        background-color: #fff;
        margin: 5% auto; 
        padding: 0; 
        border: 1px solid #888;
        width: 80%; 
        max-width: 800px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        position: relative;
        animation: slidein 0.3s;
    }
    @keyframes slidein { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    .modal-header {
        padding: 15px 20px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
        border-radius: 8px 8px 0 0;
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; line-height: 1.6; color: #333; }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-btn:hover { color: #000; }
    
    .help-h3 { border-left: 4px solid #1890ff; padding-left: 10px; margin-top: 20px; background: #e6f7ff; padding: 5px 10px; font-size: 1.1em; font-weight: bold; }
    .help-key { background: #eee; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; font-weight: bold; font-size: 0.9em; }
    .help-link { color: #1890ff; text-decoration: none; font-weight: bold; }
    .help-link:hover { text-decoration: underline; }

    /* Legend Colors */
    .legend-box { display: inline-block; width: 12px; height: 12px; margin-right: 5px; border-radius: 2px; vertical-align: middle; }
    .legend-func { background-color: #008000; }
    .legend-var { background-color: #a52a2a; }
    .legend-arg { background-color: #d4a017; }
    .legend-other { background-color: #0000ff; }

</style>
</head>
<body class="show-errors">

<div id="help-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0; padding:0; background:none; border:none;">Pico AutoInput Editor ã¸ã‚ˆã†ã“ã</h2>
            <span class="close-btn" onclick="closeHelp()">&times;</span>
        </div>
        <div class="modal-body">
            <p>ã“ã®ã‚¨ãƒ‡ã‚£ã‚¿ã¯ã€<b>Pico AutoInput</b> ãƒ‡ãƒã‚¤ã‚¹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆç·¨é›†ã‚’æ”¯æ´ã™ã‚‹å…¬å¼ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>

            <h3 class="help-h3">ã‚¨ãƒ‡ã‚£ã‚¿ã®é…è‰²ï¼ˆã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰</h3>
            <ul>
                <li><span class="legend-box legend-func"></span><b style="color:#008000">ç·‘è‰²</b> : ã‚³ãƒãƒ³ãƒ‰ã€é–¢æ•°ã€æ§‹æ–‡ (ä¾‹: <code>WAIT</code>, <code>(</code>, <code>)</code>)</li>
                <li><span class="legend-box legend-var"></span><b style="color:#a52a2a">èŒ¶è‰²</b> : å¤‰æ•°ã€ãƒ©ãƒ™ãƒ« (ä¾‹: <code>i</code>, <code>LOOP</code>)</li>
                <li><span class="legend-box legend-arg"></span><b style="color:#d4a017">é»„è‰²</b> : å¼•æ•°ã€æ•°å€¤ã€å®šæ•° (ä¾‹: <code>0.5</code>, <code>LEFT</code>)</li>
                <li><span class="legend-box legend-other"></span><b style="color:#0000ff">é’è‰²</b> : ã‚³ãƒ¡ãƒ³ãƒˆã€ãã®ä»– (ä¾‹: <code>REM</code>, <code>#</code>)</li>
                <li><b style="border-bottom:2px solid #008000; background:rgba(0,255,0,0.1)">ç·‘ã®ä¸‹ç·š</b> : ç¾åœ¨ã‚«ãƒ¼ã‚½ãƒ«ãŒã‚ã‚‹æ‹¬å¼§ã«å¯¾å¿œã™ã‚‹ãƒšã‚¢</li>
            </ul>

            <h3 class="help-h3">ã‚¨ãƒ‡ã‚£ã‚¿ã®æ©Ÿèƒ½</h3>
            <ul>
                <li><b>å…¥åŠ›è£œå®Œ:</b> <span class="help-key">MousePress</span> ç­‰ã®å¼•æ•°å…¥åŠ›ä¸­ã«å€™è£œã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§æŒ¿å…¥ã§ãã€æ—¢å­˜ã®æ–‡å­—ã¯æ­£ã—ãç½®æ›ã•ã‚Œã¾ã™ã€‚</li>
                <li><b>ãƒ©ãƒ™ãƒ«è£œå®Œ:</b> <span class="help-key">GOTO</span> ã‚„ <span class="help-key">IF...GOTO</span> å…¥åŠ›æ™‚ã€å®šç¾©æ¸ˆã¿ã®ãƒ©ãƒ™ãƒ«ãŒå€™è£œã«å‡ºã¾ã™ã€‚</li>
                <li><b>ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹:</b> å³ãƒ‘ãƒãƒ«ã®é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®ã‚³ãƒãƒ³ãƒ‰ãŒã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚</li>
            </ul>

            <h3 class="help-h3">ã‚µãƒ³ãƒ—ãƒ«ã®ä½¿ã„æ–¹</h3>
            <ol>
                <li>ã‚¨ãƒ‡ã‚£ã‚¿ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹ã‹ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚</li>
                <li>ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ã€Œ<b>ä¿å­˜</b>ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ <code>Script.txt</code> ã«ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚</li>
                <li>Pico AutoInput ã‚’PCã«æ¥ç¶šã—ã€USBãƒ‰ãƒ©ã‚¤ãƒ–ã¨ã—ã¦èªè­˜ã•ã›ã¾ã™ã€‚</li>
                <li>ä¿å­˜ã—ãŸ <code>Script.txt</code> ã‚’ãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ«ãƒ¼ãƒˆï¼ˆä¸€ç•ªä¸Šã®éšå±¤ï¼‰ã«ã‚³ãƒ”ãƒ¼ï¼ˆä¸Šæ›¸ãï¼‰ã—ã¾ã™ã€‚</li>
                <li>PCã‹ã‚‰å–ã‚Šå¤–ã—ã€Picoã® <b>BOOTSELãƒœã‚¿ãƒ³</b> ã‚’çŸ­ãæŠ¼ã™ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</li>
            </ol>

            <h3 class="help-h3">ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®æ›´æ–°æ–¹æ³•</h3>
            <ol>
                <li>æœ€æ–°ã®ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ (<code>.uf2</code> ãƒ•ã‚¡ã‚¤ãƒ«) ã‚’å…¥æ‰‹ã—ã¾ã™ã€‚<br>
                    é…å¸ƒURL: <a href="#" class="help-link" onclick="alert('é…å¸ƒURLã¯å¾Œæ—¥æ±ºå®šã•ã‚Œã¾ã™ã€‚')">[ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰]</a> (æº–å‚™ä¸­)</li>
                <li>Picoã‚’PCã‹ã‚‰å–ã‚Šå¤–ã—ã¾ã™ã€‚</li>
                <li>Picoæœ¬ä½“ã® <b>BOOTSELãƒœã‚¿ãƒ³</b> ã‚’<b>æŠ¼ã—ãŸã¾ã¾</b>ã€USBã‚±ãƒ¼ãƒ–ãƒ«ã§PCã«æ¥ç¶šã—ã¾ã™ã€‚</li>
                <li>"RPI-RP2" ã¨ã„ã†ãƒ‰ãƒ©ã‚¤ãƒ–ãŒèªè­˜ã•ã‚ŒãŸã‚‰ãƒœã‚¿ãƒ³ã‚’é›¢ã—ã¾ã™ã€‚</li>
                <li><code>.uf2</code> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ãƒ‰ãƒ©ã‚¤ãƒ–ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚è‡ªå‹•çš„ã«å†èµ·å‹•ã—ã¦æ›´æ–°å®Œäº†ã§ã™ã€‚</li>
            </ol>

            <h3 class="help-h3">ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h3>
            <ul>
                <li><b>Q. ãƒ‡ãƒã‚¤ã‚¹ãŒåå¿œã—ãªã„ / èµ·å‹•ã—ãªããªã£ãŸ</b><br>
                    A. èµ·å‹•ç›´å¾Œã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œä¸­ã«ãƒ•ãƒªãƒ¼ã‚ºã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>
                    <b>ã€Œ3å›é€£ç¶šãƒªã‚»ãƒƒãƒˆã€æ©Ÿèƒ½</b>ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚USBã‚±ãƒ¼ãƒ–ãƒ«ã‚’æŠœãå·®ã—ï¼ˆå†èµ·å‹•ï¼‰ã—ã¦ã€èµ·å‹•å‡¦ç†ä¸­ã«ã‚ã–ã¨é›»æºã‚’åˆ‡ã‚‹ã€ã‚’3å›ç¹°ã‚Šè¿”ã™ã¨ã€è‡ªå‹•çš„ã«å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒåˆæœŸåŒ–ã•ã‚Œã¦å¾©æ—§ã—ã¾ã™ã€‚</li>
            </ul>
        </div>
    </div>
</div>

<div id="container">
    <div id="editor-pane">
        <div id="toolbar">
            <span style="font-weight:bold;">Pico AutoInput Editor v6</span>
            <button class="tool-btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ é–‹ã</button>
            <input type="file" id="file-input" accept=".txt" style="display:none">
            <button class="tool-btn" onclick="saveFile()">ğŸ’¾ ä¿å­˜</button>
            <button class="tool-btn" onclick="openHelp()">â“ ä½¿ã„æ–¹</button>
            <label class="toggle-label" style="margin-left:auto;">
                <input type="checkbox" id="chk-errors" checked onchange="toggleErrors()">
                <span>âš ï¸ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º</span>
            </label>
        </div>
        <div id="status-area">æº–å‚™å®Œäº†</div>
        
        <div id="editor-wrapper">
            <pre id="code-highlight" class="editor-layer"></pre>
            <textarea id="code-input" class="editor-layer" spellcheck="false" placeholder="// ã“ã“ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            <div id="autocomplete-list"></div>
        </div>
    </div>

    <div id="info-pane">
        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('reference')">ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</div>
            <div class="tab" onclick="switchTab('structure')">æ§‹é€ è§£æ</div>
            <div class="tab" onclick="switchTab('flowchart')">ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</div>
        </div>

        <div id="reference" class="tab-content active">
            <p style="font-size:0.85rem; color:#666; margin:0 0 15px 0; background:#fff8c4; padding:5px;">
                â€» ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚<br>
                â€» <code>expr</code> ã¯æ•°å¼ã‚„æ•°å€¤ã‚’æ„å‘³ã—ã¾ã™ã€‚
            </p>
            
            <div class="doc-section">
                <h2>åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰</h2>
                <div class="doc-item" onclick="insertText('WAIT 1.0')"><span class="doc-syntax">WAIT expr</span><div class="doc-desc">æŒ‡å®šã—ãŸç§’æ•°ã ã‘å¾…æ©Ÿã—ã¾ã™ã€‚<br>ä¾‹: <code>WAIT 0.5</code> (0.5ç§’å¾…ã¤)</div></div>
                <div class="doc-item" onclick="insertText('END')"><span class="doc-syntax">END</span><div class="doc-desc">ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã‚’çµ‚äº†ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('PRINT expr')"><span class="doc-syntax">PRINT expr</span><div class="doc-desc">æ•°å¼ã®çµæœã‚’ãƒ‡ãƒãƒƒã‚°ç”¨ã‚·ãƒªã‚¢ãƒ«ãƒ¢ãƒ‹ã‚¿ã«å‡ºåŠ›ã—ã¾ã™ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ (åˆ†å²ãƒ»ãƒ«ãƒ¼ãƒ—)</h2>
                <div class="doc-item" onclick="insertText('LABEL Name')"><span class="doc-syntax">LABEL Name</span><div class="doc-desc">ã‚¸ãƒ£ãƒ³ãƒ—å…ˆã®ã€Œç›®å°ã€ã‚’ä½œã‚Šã¾ã™ã€‚åå‰ã¯ä»»æ„ã§ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('GOTO Name')"><span class="doc-syntax">GOTO Name</span><div class="doc-desc">æŒ‡å®šã—ãŸãƒ©ãƒ™ãƒ«ã®è¡Œã¸ç§»å‹•ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('IF expr GOTO Name')"><span class="doc-syntax">IF expr GOTO Name</span><div class="doc-desc">æ¡ä»¶å¼ <code>expr</code> ãŒçœŸ(0ä»¥å¤–)ãªã‚‰ã€æŒ‡å®šãƒ©ãƒ™ãƒ«ã¸ç§»å‹•ã—ã¾ã™ã€‚<br>ä¾‹: <code>IF count &lt; 5 GOTO LOOP</code></div></div>
                <div class="doc-item" onclick="insertText('GOSUB Name')"><span class="doc-syntax">GOSUB Name</span><div class="doc-desc">ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³(éƒ¨å“åŒ–ã—ãŸå‡¦ç†)ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('RETURN')"><span class="doc-syntax">RETURN</span><div class="doc-desc">ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³ã‹ã‚‰å…ƒã®å ´æ‰€ã«æˆ»ã‚Šã¾ã™ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>å¤‰æ•°æ“ä½œ</h2>
                <div class="doc-item" onclick="insertText('SET var = expr')"><span class="doc-syntax">SET var = expr</span><div class="doc-desc">å¤‰æ•° <code>var</code> ã«è¨ˆç®—çµæœã‚’ä»£å…¥ã—ã¾ã™ã€‚<br>ä¾‹: <code>SET i = i + 1</code></div></div>
            </div>

            <div class="doc-section">
                <h2>è¨­å®šãƒ»ãƒ¢ãƒ¼ãƒ‰</h2>
                <div class="doc-item" onclick="insertText('Mode(KeyMouse)')"><span class="doc-syntax">Mode(KeyMouse)</span><div class="doc-desc">ã€Œã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ãƒã‚¦ã‚¹ã€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('Mode(ProController)')"><span class="doc-syntax">Mode(ProController)</span><div class="doc-desc">ã€ŒSwitch Proã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('UseLED(1)')"><span class="doc-syntax">UseLED(1)</span><div class="doc-desc">LEDåˆ¶å¾¡æ©Ÿèƒ½ã‚’æœ‰åŠ¹(1)ã¾ãŸã¯ç„¡åŠ¹(0)ã«ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('SetLED(255,0,0)')"><span class="doc-syntax">SetLED(r, g, b)</span><div class="doc-desc">LEDã®è‰²ã‚’RGB(0-255)ã§æŒ‡å®šã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('DEBUG(1)')"><span class="doc-syntax">DEBUG(1)</span><div class="doc-desc">è©³ç´°ãªå®Ÿè¡Œãƒ­ã‚°å‡ºåŠ›ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ãƒã‚¦ã‚¹æ“ä½œ</h2>
                <div class="doc-item" onclick="insertText('KeyPress(A)')"><span class="doc-syntax">KeyPress(key)</span><div class="doc-desc">ã‚­ãƒ¼ã‚’æŠ¼ã—ã£ã±ãªã—ã«ã—ã¾ã™ã€‚<br>ä¾‹: <code>A</code>, <code>ENTER</code>, <code>SHIFT</code></div></div>
                <div class="doc-item" onclick="insertText('KeyRelease(A)')"><span class="doc-syntax">KeyRelease(key)</span><div class="doc-desc">æŠ¼ã—ã¦ã„ã‚‹ã‚­ãƒ¼ã‚’é›¢ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('KeyPushFor(A, 0.1)')"><span class="doc-syntax">KeyPushFor(key, sec)</span><div class="doc-desc">ã‚­ãƒ¼ã‚’æŒ‡å®šç§’æ•°ã ã‘æŠ¼ã—ã¦é›¢ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('KeyType(&quot;Hello&quot;, 0.05, 0.05)')"><span class="doc-syntax">KeyType("text", p, r)</span><div class="doc-desc">æ–‡å­—åˆ—ã‚’ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚p=æŠ¼ä¸‹æ™‚é–“, r=é–“éš”(ç§’)ã€‚</div></div>
                <div class="doc-item" onclick="insertText('MouseMove(100, 0, 1)')"><span class="doc-syntax">MouseMove(x, y, rel)</span><div class="doc-desc">ãƒã‚¦ã‚¹ã‚’ç§»å‹•ã—ã¾ã™ã€‚rel=1ã§ç›¸å¯¾ç§»å‹•ã€0ã§çµ¶å¯¾ç§»å‹•ã€‚</div></div>
                <div class="doc-item" onclick="insertText('MousePress(LEFT)')"><span class="doc-syntax">MousePress(btn)</span><div class="doc-desc">ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™(LEFT/RIGHT/MIDDLE)ã€‚</div></div>
                <div class="doc-item" onclick="insertText('MouseRelease(LEFT)')"><span class="doc-syntax">MouseRelease(btn)</span><div class="doc-desc">ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ã‚’é›¢ã—ã¾ã™ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>Proã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ“ä½œ</h2>
                <div class="doc-item" onclick="insertText('ProConPress(A)')"><span class="doc-syntax">ProConPress(btn)</span><div class="doc-desc">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚<br>A, B, X, Y, L, R, ZL, ZR, HOMEãªã©ã€‚</div></div>
                <div class="doc-item" onclick="insertText('ProConRelease(A)')"><span class="doc-syntax">ProConRelease(btn)</span><div class="doc-desc">ãƒœã‚¿ãƒ³ã‚’é›¢ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('ProConPushFor(A, 0.1)')"><span class="doc-syntax">ProConPushFor(btn, sec)</span><div class="doc-desc">ãƒœã‚¿ãƒ³ã‚’æŒ‡å®šç§’æ•°ã ã‘æŠ¼ã—ã¦é›¢ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('ProConHat(UP)')"><span class="doc-syntax">ProConHat(dir)</span><div class="doc-desc">åå­—ã‚­ãƒ¼ã‚’æŠ¼ã—ã¾ã™ã€‚<br>UP, DOWN, LEFT, RIGHT, UP_RIGHTãªã©ã€‚</div></div>
                <div class="doc-item" onclick="insertText('ProConJoy(0, 0, 0, 0)')"><span class="doc-syntax">ProConJoy(lx, ly, rx, ry)</span><div class="doc-desc">ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’å€’ã—ã¾ã™ã€‚ç¯„å›²ã¯ -128 ï½ 127ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>å›ºæœ‰é–¢æ•° (å¼ã®ä¸­ã§ä½¿ç”¨)</h2>
                <div class="doc-item" onclick="insertText('IsPressed()')"><span class="doc-syntax">IsPressed()</span><div class="doc-desc">æœ¬ä½“ã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ã‚Œã° 1.0ã€é›¢ã‚Œã¦ã„ã‚Œã° 0.0 ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('Rand(0, 10)')"><span class="doc-syntax">Rand(min, max)</span><div class="doc-desc">min ã‹ã‚‰ max ã¾ã§ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°å€¤ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('GetTime()')"><span class="doc-syntax">GetTime()</span><div class="doc-desc">ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹ã‹ã‚‰ã®çµŒéæ™‚é–“(ãƒŸãƒªç§’)ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>æ•°å­¦é–¢æ•° (åŸºæœ¬)</h2>
                <div class="doc-item" onclick="insertText('abs(x)')"><span class="doc-syntax">abs(x)</span><div class="doc-desc">çµ¶å¯¾å€¤ï¼ˆæ­£ã®å€¤ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('round(x, 0)')"><span class="doc-syntax">round(x, d)</span><div class="doc-desc">x ã‚’å°æ•°ç‚¹ä»¥ä¸‹ d æ¡ã§å››æ¨äº”å…¥ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('floor(x)')"><span class="doc-syntax">floor(x)</span><div class="doc-desc">å°æ•°ç‚¹ä»¥ä¸‹ã‚’åˆ‡ã‚Šæ¨ã¦ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('ceil(x)')"><span class="doc-syntax">ceil(x)</span><div class="doc-desc">å°æ•°ç‚¹ä»¥ä¸‹ã‚’åˆ‡ã‚Šä¸Šã’ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('trunc(x)')"><span class="doc-syntax">trunc(x)</span><div class="doc-desc">æ•´æ•°éƒ¨åˆ†ã®ã¿ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('min(a, b)')"><span class="doc-syntax">min(a, b, ...)</span><div class="doc-desc">å¼•æ•°ã®ä¸­ã§æœ€å°ã®å€¤ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('max(a, b)')"><span class="doc-syntax">max(a, b, ...)</span><div class="doc-desc">å¼•æ•°ã®ä¸­ã§æœ€å¤§ã®å€¤ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('clamp(x, min, max)')"><span class="doc-syntax">clamp(x, min, max)</span><div class="doc-desc">x ã‚’ minï½max ã®ç¯„å›²å†…ã«åã‚ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('mod(a, b)')"><span class="doc-syntax">mod(a, b)</span><div class="doc-desc">a ã‚’ b ã§å‰²ã£ãŸä½™ã‚Šã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('pow(x, y)')"><span class="doc-syntax">pow(x, y)</span><div class="doc-desc">x ã® y ä¹—ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('sqrt(x)')"><span class="doc-syntax">sqrt(x)</span><div class="doc-desc">x ã®å¹³æ–¹æ ¹ï¼ˆãƒ«ãƒ¼ãƒˆï¼‰ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('pi()')"><span class="doc-syntax">pi()</span><div class="doc-desc">å††å‘¨ç‡ (ç´„3.14159) ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('e()')"><span class="doc-syntax">e()</span><div class="doc-desc">ãƒã‚¤ãƒ”ã‚¢æ•° (ç´„2.71828) ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>æ•°å­¦é–¢æ•° (ä¸‰è§’é–¢æ•°)</h2>
                <div class="doc-item" onclick="insertText('sin(x)')"><span class="doc-syntax">sin(x)</span><div class="doc-desc">æ­£å¼¦(ã‚µã‚¤ãƒ³)ã‚’è¿”ã—ã¾ã™ã€‚xã¯ãƒ©ã‚¸ã‚¢ãƒ³ã€‚</div></div>
                <div class="doc-item" onclick="insertText('cos(x)')"><span class="doc-syntax">cos(x)</span><div class="doc-desc">ä½™å¼¦(ã‚³ã‚µã‚¤ãƒ³)ã‚’è¿”ã—ã¾ã™ã€‚xã¯ãƒ©ã‚¸ã‚¢ãƒ³ã€‚</div></div>
                <div class="doc-item" onclick="insertText('tan(x)')"><span class="doc-syntax">tan(x)</span><div class="doc-desc">æ­£æ¥(ã‚¿ãƒ³ã‚¸ã‚§ãƒ³ãƒˆ)ã‚’è¿”ã—ã¾ã™ã€‚xã¯ãƒ©ã‚¸ã‚¢ãƒ³ã€‚</div></div>
                <div class="doc-item" onclick="insertText('asin(x)')"><span class="doc-syntax">asin(x)</span><div class="doc-desc">ã‚¢ãƒ¼ã‚¯ã‚µã‚¤ãƒ³ï¼ˆé€†æ­£å¼¦ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('acos(x)')"><span class="doc-syntax">acos(x)</span><div class="doc-desc">ã‚¢ãƒ¼ã‚¯ã‚³ã‚µã‚¤ãƒ³ï¼ˆé€†ä½™å¼¦ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('atan(x)')"><span class="doc-syntax">atan(x)</span><div class="doc-desc">ã‚¢ãƒ¼ã‚¯ã‚¿ãƒ³ã‚¸ã‚§ãƒ³ãƒˆï¼ˆé€†æ­£æ¥ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('atan2(y, x)')"><span class="doc-syntax">atan2(y, x)</span><div class="doc-desc">åº§æ¨™(x,y)ã®è§’åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã§è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('sinh(x)')"><span class="doc-syntax">sinh / cosh / tanh</span><div class="doc-desc">åŒæ›²ç·šé–¢æ•°ã§ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('rad2deg(x)')"><span class="doc-syntax">rad2deg(x)</span><div class="doc-desc">ãƒ©ã‚¸ã‚¢ãƒ³ã‚’åº¦æ•°æ³•(0-360)ã«å¤‰æ›ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('deg2rad(x)')"><span class="doc-syntax">deg2rad(x)</span><div class="doc-desc">åº¦æ•°æ³•ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›ã—ã¾ã™ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>æ•°å­¦é–¢æ•° (ãã®ä»–ãƒ»å¯¾æ•°ãƒ»çµ„åˆã›)</h2>
                <div class="doc-item" onclick="insertText('ln(x)')"><span class="doc-syntax">ln(x)</span><div class="doc-desc">è‡ªç„¶å¯¾æ•°ï¼ˆåº•ãŒeï¼‰ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('log10(x)')"><span class="doc-syntax">log10(x)</span><div class="doc-desc">å¸¸ç”¨å¯¾æ•°ï¼ˆåº•ãŒ10ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('fact(n)')"><span class="doc-syntax">fact(n)</span><div class="doc-desc">nã®éšä¹— (n!) ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('ncr(n, r)')"><span class="doc-syntax">ncr(n, r)</span><div class="doc-desc">çµ„åˆã› (nCr) ã®æ•°ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('npr(n, r)')"><span class="doc-syntax">npr(n, r)</span><div class="doc-desc">é †åˆ— (nPr) ã®æ•°ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('sign(x)')"><span class="doc-syntax">sign(x)</span><div class="doc-desc">æ­£ãªã‚‰1ã€è² ãªã‚‰-1ã€0ãªã‚‰0ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
            </div>

            <div class="doc-section">
                <h2>è«–ç†ãƒ»æ¡ä»¶é–¢æ•°</h2>
                <div class="doc-item" onclick="insertText('if(c, t, f)')"><span class="doc-syntax">if(cond, true, false)</span><div class="doc-desc">æ¡ä»¶å¼ cond ãŒçœŸãªã‚‰ trueã€å½ãªã‚‰ false ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('not(x)')"><span class="doc-syntax">not(x)</span><div class="doc-desc">xãŒ0ãªã‚‰1ã€ãã‚Œä»¥å¤–ãªã‚‰0ã‚’è¿”ã—ã¾ã™(å¦å®š)ã€‚</div></div>
                <div class="doc-item" onclick="insertText('and(a, b)')"><span class="doc-syntax">and(a, b)</span><div class="doc-desc">ä¸¡æ–¹ãŒçœŸ(0ä»¥å¤–)ã®ã¨ãã®ã¿1ã‚’è¿”ã—ã¾ã™(è«–ç†ç©)ã€‚</div></div>
                <div class="doc-item" onclick="insertText('or(a, b)')"><span class="doc-syntax">or(a, b)</span><div class="doc-desc">ã©ã¡ã‚‰ã‹ãŒçœŸ(0ä»¥å¤–)ãªã‚‰1ã‚’è¿”ã—ã¾ã™(è«–ç†å’Œ)ã€‚</div></div>
                <div class="doc-item" onclick="insertText('even(x)')"><span class="doc-syntax">even(x)</span><div class="doc-desc">xã‚’æœ€ã‚‚è¿‘ã„å¶æ•°ã«ä¸¸ã‚ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('odd(x)')"><span class="doc-syntax">odd(x)</span><div class="doc-desc">xã‚’æœ€ã‚‚è¿‘ã„å¥‡æ•°ã«ä¸¸ã‚ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('iseven(x)')"><span class="doc-syntax">iseven(x)</span><div class="doc-desc">xãŒå¶æ•°ãªã‚‰1ã€å¥‡æ•°ãªã‚‰0ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
                <div class="doc-item" onclick="insertText('isodd(x)')"><span class="doc-syntax">isodd(x)</span><div class="doc-desc">xãŒå¥‡æ•°ãªã‚‰1ã€å¶æ•°ãªã‚‰0ã‚’è¿”ã—ã¾ã™ã€‚</div></div>
            </div>
        </div>

        <div id="structure" class="tab-content">
            <div class="struct-item" style="cursor:default; background:#eee;"><b>ãƒ©ãƒ™ãƒ«ä¸€è¦§</b></div>
            <div id="label-list"></div>
            <div class="struct-item" style="cursor:default; background:#eee; margin-top:20px;"><b>å¤‰æ•°ä¸€è¦§</b></div>
            <div id="var-list"></div>
        </div>

        <div id="flowchart" class="tab-content">
            <div id="mermaid-container">Loading...</div>
            <button class="tool-btn" onclick="analyzeCode()" style="margin-top:10px;">æ›´æ–°</button>
        </div>
    </div>
</div>

<script>
    // --- Logic Constants ---
    const COMMANDS = [
        "LABEL", "GOTO", "IF", "GOSUB", "RETURN", "WAIT", "END",
        "SET", "PRINT", "DEBUG", "REM",
        "Mode", "UseLED", "SetLED",
        "KeyPress", "KeyRelease", "KeyPushFor", "KeyType",
        "MouseMove", "MousePress", "MouseRelease", "MousePushFor", "Mouserun",
        "ProConPress", "ProConRelease", "ProConPushFor", "ProConHat", "ProConJoy"
    ];

    const BUILTIN_FUNCS = new Set([
        "ispressed", "rand", "gettime",
        "abs", "acos", "asin", "atan", "atan2", "ceil", "clamp", "cos", "cosh", "cot", 
        "deg2rad", "e", "exp", "floor", "ln", "log10", "max", "min", "mod", "pi", 
        "pow", "power", "rad2deg", "round", "sign", "sin", "sinh", "sqr", "sqrt", 
        "sum", "tan", "tanh", "trunc", "fac", "fact", "ncr", "npr", "permut", "combin",
        "if", "ifs", "not", "and", "or", "true", "false", "nan", "even", "odd",
        "iseven", "isodd", "isnan", "iserr", "effect", "nominal"
    ]);

    const AC_CONSTANTS = {
        "MousePress": ["LEFT", "RIGHT", "MIDDLE"],
        "MouseRelease": ["LEFT", "RIGHT", "MIDDLE"],
        "MousePushFor": ["LEFT", "RIGHT", "MIDDLE"],
        "Mode": ["KeyMouse", "ProController"],
        "ProConPress": ["A", "B", "X", "Y", "L", "R", "ZL", "ZR", "MINUS", "PLUS", "HOME", "CAPTURE", "LCLICK", "RCLICK", "UP", "DOWN", "LEFT", "RIGHT"],
        "ProConRelease": ["A", "B", "X", "Y", "L", "R", "ZL", "ZR", "MINUS", "PLUS", "HOME", "CAPTURE", "LCLICK", "RCLICK"],
        "ProConPushFor": ["A", "B", "X", "Y", "L", "R", "ZL", "ZR", "MINUS", "PLUS", "HOME", "CAPTURE", "LCLICK", "RCLICK"],
        "ProConHat": ["UP", "UP_RIGHT", "RIGHT", "RIGHT_DOWN", "DOWN", "DOWN_LEFT", "LEFT", "LEFT_UP", "CENTER"],
        "KeyPress": ["ENTER", "SPACE", "ESC", "TAB", "BACKSPACE", "CAPSLOCK", "UP", "DOWN", "LEFT", "RIGHT", "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F11", "F12"],
        "KeyRelease": ["ENTER", "SPACE", "ESC", "TAB", "BACKSPACE", "UP", "DOWN", "LEFT", "RIGHT"],
        "KeyPushFor": ["ENTER", "SPACE", "ESC", "TAB", "BACKSPACE", "UP", "DOWN", "LEFT", "RIGHT"]
    };
    
    const VALID_CONSTANTS = new Set(Object.values(AC_CONSTANTS).flat().map(s => s.toUpperCase()));

    // --- DOM Elements ---
    const inputEl = document.getElementById('code-input');
    const highlightEl = document.getElementById('code-highlight');
    const acList = document.getElementById('autocomplete-list');
    const modal = document.getElementById('help-modal');
    
    // --- State ---
    let definedLabels = new Map();
    let definedVars = new Map();
    let scriptLines = [];
    // For paren matching
    let matchedParenIndices = new Set(); 

    // --- Init ---
    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    // Event Listeners
    inputEl.addEventListener('input', () => { analyzeCode(); checkAutocomplete(); updateParenMatch(); });
    inputEl.addEventListener('scroll', () => {
        highlightEl.scrollTop = inputEl.scrollTop;
        highlightEl.scrollLeft = inputEl.scrollLeft;
    });
    inputEl.addEventListener('keydown', handleKey);
    inputEl.addEventListener('click', () => { checkAutocomplete(); updateParenMatch(); });
    inputEl.addEventListener('keyup', () => { updateParenMatch(); });
    inputEl.addEventListener('blur', () => { setTimeout(() => acList.style.display = 'none', 200); });
    
    // Show help on startup
    window.onload = () => { 
        analyzeCode(); 
        openHelp(); 
    };

    // --- Core Logic ---
    function analyzeCode() {
        const text = inputEl.value;
        scriptLines = text.split(/\r?\n/);
        definedLabels.clear();
        definedVars.clear();
        let errorCount = 0;

        // Pass 1: Definitions
        scriptLines.forEach((line, i) => {
            const t = line.trim();
            if (!t || t.startsWith('#') || t.toUpperCase().startsWith('REM')) return;
            if (t.toUpperCase().startsWith('LABEL')) {
                const p = t.split(/\s+/);
                if (p[1]) definedLabels.set(p[1], i + 1);
            }
            if (t.toUpperCase().startsWith('SET')) {
                const eq = t.indexOf('=');
                if (eq > 3) {
                    const v = t.substring(3, eq).trim();
                    const vName = v.split(/\s+/)[0];
                    if (!definedVars.has(vName)) definedVars.set(vName, i + 1);
                }
            }
        });

        updateStructureTab();

        // Pass 2: Rendering
        let html = "";
        let globalCharIndex = 0;

        scriptLines.forEach((line, i) => {
            const safeLine = escapeHtml(line);
            let lineHtml = safeLine;
            let bgClass = "";
            let msgHtml = "";

            const trim = line.trim();
            if (trim.length > 0 && !trim.startsWith('#') && !trim.toUpperCase().startsWith('REM')) {
                const sp = trim.indexOf(' ');
                const cmdRaw = (sp === -1 ? trim : trim.substring(0, sp)).toUpperCase();
                const paren = cmdRaw.indexOf('(');
                const cmdPure = (paren !== -1 ? cmdRaw.substring(0, paren) : cmdRaw);

                if (COMMANDS.some(c => c.toUpperCase() === cmdPure)) {
                    const res = renderLine(line, cmdPure, globalCharIndex);
                    lineHtml = res.html;
                    if (res.error) {
                        bgClass = "error-bg";
                        msgHtml = `<span class="msg-text err-text">${res.error}</span>`;
                        errorCount++;
                    } else if (res.warning) {
                        bgClass = "warning-bg";
                        msgHtml = `<span class="msg-text warn-text">${res.warning}</span>`;
                    }
                } else {
                    lineHtml = `<span class="other">${safeLine}</span>`;
                }
            } else {
                if (trim.length > 0) lineHtml = `<span class="other">${safeLine}</span>`;
            }

            html += `<div class="line ${bgClass}">${lineHtml}${msgHtml}</div>`;
            // +1 for newline char
            globalCharIndex += line.length + 1;
        });
        
        if (text.endsWith('\n')) html += `<div class="line"><br></div>`;
        
        highlightEl.innerHTML = html;
        const st = document.getElementById('status-area');
        st.textContent = errorCount === 0 ? "OK: ã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“" : `ã‚¨ãƒ©ãƒ¼: ${errorCount} ä»¶`;
        st.style.color = errorCount === 0 ? "green" : "red";
    }

    // Render a single line with syntax coloring & paren match check
    function renderLine(line, cmdPure, lineStartIndex) {
        let html = "";
        let error = null;
        let warning = null;
        
        // Helper to check if a char at relative index 'relIdx' is matched
        const isMatched = (relIdx) => matchedParenIndices.has(lineStartIndex + relIdx);

        const match = line.match(new RegExp(`^(\\s*)(${cmdPure})`, "i"));
        if (!match) return { html: escapeHtml(line) };

        const indent = escapeHtml(match[1]);
        const cmdStr = escapeHtml(match[2]);
        const restRaw = line.substring(match[0].length);
        const restStartIdx = match[0].length; // relative to line

        if (restRaw.startsWith('(')) {
            html += `<span class="other">${indent}</span><span class="func">${cmdStr}</span>`;
            
            const endP = restRaw.lastIndexOf(')');
            if (endP !== -1) {
                // '('
                const openIdx = restStartIdx; 
                const openClass = isMatched(openIdx) ? "func paren-match" : "func";
                html += `<span class="${openClass}">(</span>`;
                
                const args = restRaw.substring(1, endP);
                html += colorizeArgs(args, lineStartIndex + restStartIdx + 1); // +1 for '('

                // ')'
                const closeIdx = restStartIdx + endP;
                const closeClass = isMatched(closeIdx) ? "func paren-match" : "func";
                html += `<span class="${closeClass}">)</span>`;
                
                const tail = restRaw.substring(endP + 1);
                if (tail.trim().length > 0) {
                    html += `<span class="other">${escapeHtml(tail)}</span>`;
                    warning = "é–‰ã˜æ‹¬å¼§ã®å¾Œã‚ã®æ–‡å­—ã¯ç„¡è¦–ã•ã‚Œã¾ã™";
                } else {
                    html += escapeHtml(tail);
                }
                
                const err = validateExpr(args);
                if (err) error = err;
            } else {
                // Unmatched '('
                const openIdx = restStartIdx;
                const openClass = isMatched(openIdx) ? "func paren-match" : "func";
                html += `<span class="${openClass}">(</span>` + colorizeArgs(restRaw.substring(1), lineStartIndex + restStartIdx + 1);
                error = "é–‰ã˜æ‹¬å¼§ ) ãŒã‚ã‚Šã¾ã›ã‚“";
            }
        } else {
            html += `<span class="other">${indent}</span><span class="func">${cmdStr}</span>`;
            let args = restRaw;
            let argsGlobalStart = lineStartIndex + restStartIdx;

            if (cmdPure === "SET") {
                const eq = args.indexOf('=');
                if (eq !== -1) {
                    const vPart = args.substring(0, eq);
                    const vMatch = vPart.match(/([a-zA-Z_][a-zA-Z0-9_]*)/);
                    if(vMatch) {
                         const pre = vPart.substring(0, vMatch.index);
                         const post = vPart.substring(vMatch.index + vMatch[0].length);
                         html += `<span class="other">${escapeHtml(pre)}</span><span class="var">${vMatch[0]}</span><span class="other">${escapeHtml(post)}</span>`;
                    } else {
                        html += `<span class="other">${escapeHtml(vPart)}</span>`;
                    }
                    html += `<span class="func">=</span>`;
                    const expr = args.substring(eq + 1);
                    html += colorizeArgs(expr, argsGlobalStart + eq + 1);
                    const err = validateExpr(expr);
                    if (err) error = err;
                } else {
                    html += `<span class="other">${escapeHtml(args)}</span>`;
                    error = "= ãŒå¿…è¦ã§ã™";
                }
            } else if (cmdPure === "GOTO" || cmdPure === "GOSUB") {
                const lbl = args.trim();
                html += `<span class="label-ref">${escapeHtml(args)}</span>`;
                if (!definedLabels.has(lbl)) error = "æœªå®šç¾©ãƒ©ãƒ™ãƒ«";
            } else if (cmdPure === "IF") {
                const gt = args.toUpperCase().indexOf("GOTO");
                if (gt !== -1) {
                    const expr = args.substring(0, gt);
                    const lblPart = args.substring(gt + 4);
                    html += colorizeArgs(expr, argsGlobalStart);
                    html += `<span class="func">GOTO</span>`;
                    html += `<span class="label-ref">${escapeHtml(lblPart)}</span>`;
                    
                    const err = validateExpr(expr);
                    if (err) error = err;
                    if (!definedLabels.has(lblPart.trim())) error = (error ? error+" " : "") + "æœªå®šç¾©ãƒ©ãƒ™ãƒ«";
                } else {
                    html += colorizeArgs(args, argsGlobalStart);
                    error = "GOTO ãŒå¿…è¦ã§ã™";
                }
            } else if (cmdPure === "LABEL") {
                html += `<span class="label-def">${escapeHtml(args)}</span>`;
            } else {
                html += colorizeArgs(args, argsGlobalStart);
                if (cmdPure === "WAIT") {
                     const err = validateExpr(args);
                     if(err) error = err;
                }
            }
        }
        return { html, error, warning };
    }

    function colorizeArgs(text, startGlobalIndex) {
        let html = "";
        const regex = /([a-zA-Z_][a-zA-Z0-9_]*)|([(),])|([^a-zA-Z_(),]+)/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
            const str = match[0];
            const safe = escapeHtml(str);
            const tokenGlobalIdx = startGlobalIndex + match.index;

            if (match[1]) { 
                const low = str.toLowerCase();
                if (BUILTIN_FUNCS.has(low)) html += `<span class="func">${safe}</span>`;
                else if (definedVars.has(str)) html += `<span class="var">${safe}</span>`;
                else if (VALID_CONSTANTS.has(str.toUpperCase())) html += `<span class="arg">${safe}</span>`;
                else html += `<span class="arg">${safe}</span>`;
            } else if (match[2]) {
                // Parens inside args
                if (str === '(' || str === ')') {
                    const pClass = isMatchedGlobal(tokenGlobalIdx) ? "func paren-match" : "func";
                    html += `<span class="${pClass}">${safe}</span>`;
                } else {
                    html += `<span class="func">${safe}</span>`; // Comma
                }
            } else {
                html += `<span class="arg">${safe}</span>`;
            }
        }
        return html;
    }
    
    function isMatchedGlobal(idx) {
        return matchedParenIndices.has(idx);
    }

    function validateExpr(expr) {
        const noStr = expr.replace(/"[^"]*"/g, "0");
        const tokens = noStr.match(/[a-zA-Z_][a-zA-Z0-9_]*/g);
        if (!tokens) return null;
        for (const t of tokens) {
            const low = t.toLowerCase();
            if (BUILTIN_FUNCS.has(low)) continue;
            if (VALID_CONSTANTS.has(t.toUpperCase())) continue;
            if (definedVars.has(t)) continue;
            if (COMMANDS.some(c => c.toUpperCase() === low.toUpperCase())) continue;
            return `æœªå®šç¾©: ${t}`;
        }
        return null;
    }

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    // --- Parenthesis Matching Logic ---
    function updateParenMatch() {
        const cursor = inputEl.selectionStart;
        const text = inputEl.value;
        matchedParenIndices.clear();

        // Check char before and after cursor
        // Priority: 1. After cursor '(|' -> check '(', 2. Before cursor ')|' -> check ')'
        
        let targetIdx = -1;
        let searchDir = 0; // 1: forward, -1: backward

        if (cursor < text.length && text[cursor] === '(') {
            targetIdx = cursor; searchDir = 1;
        } else if (cursor > 0 && text[cursor-1] === ')') {
            targetIdx = cursor-1; searchDir = -1;
        } else if (cursor < text.length && text[cursor] === ')') { // Case: ')|' but check ')' after cursor
            targetIdx = cursor; searchDir = -1;
        } else if (cursor > 0 && text[cursor-1] === '(') { // Case: '(|' but check '(' before cursor
            targetIdx = cursor-1; searchDir = 1;
        }

        if (targetIdx !== -1) {
            const partner = findPartnerParen(text, targetIdx, searchDir);
            if (partner !== -1) {
                matchedParenIndices.add(targetIdx);
                matchedParenIndices.add(partner);
            }
        }
        
        // Re-render only if set changed (Optimized by simple re-render for now as it's fast)
        analyzeCode(); 
    }

    function findPartnerParen(text, idx, dir) {
        const open = '('; const close = ')';
        const target = text[idx];
        const partner = (target === open) ? close : open;
        
        let depth = 0;
        let i = idx;
        while (i >= 0 && i < text.length) {
            const c = text[i];
            if (c === target) depth++;
            else if (c === partner) depth--;
            
            if (depth === 0) return i;
            i += dir;
        }
        return -1;
    }

    // --- Autocomplete ---
    function checkAutocomplete() {
        const cursorPos = inputEl.selectionStart;
        const text = inputEl.value;
        
        const before = text.substring(0, cursorPos);
        const lineStart = before.lastIndexOf('\n') + 1;
        const lineEnd = text.indexOf('\n', cursorPos);
        const line = text.substring(lineStart, lineEnd === -1 ? text.length : lineEnd);
        const cursorInLine = cursorPos - lineStart;
        const trimLine = line.trim();

        if (!trimLine) { acList.style.display = 'none'; return; }

        // 1. Identify Command
        let activeCmd = null;
        const firstSpace = trimLine.indexOf(' ');
        const cmdRaw = (firstSpace === -1 ? trimLine : trimLine.substring(0, firstSpace)).toUpperCase();
        const paren = cmdRaw.indexOf('(');
        const cmdPure = (paren !== -1 ? cmdRaw.substring(0, paren) : cmdRaw);

        // GOTO/IF Special
        if (cmdPure === "IF") {
            const gt = line.toUpperCase().indexOf("GOTO");
            if (gt !== -1 && cursorInLine > gt + 4) activeCmd = "GOTO"; 
        } else {
            if (COMMANDS.some(c => c.toUpperCase() === cmdPure)) activeCmd = cmdPure;
        }

        if (!activeCmd) { acList.style.display = 'none'; return; }

        // 2. Candidates
        let candidates = [];
        let isLabel = (activeCmd === "GOTO" || activeCmd === "GOSUB");
        if (isLabel) candidates = Array.from(definedLabels.keys());
        else if (AC_CONSTANTS[activeCmd]) candidates = AC_CONSTANTS[activeCmd];
        else { acList.style.display = 'none'; return; }

        // 3. Find Token for replacement
        const separators = /[ \(,]/;
        let tStart = cursorInLine;
        while (tStart > 0 && !separators.test(line[tStart-1])) tStart--;
        
        // Scan forward to include rest of token (Fix for "insert cleanly")
        let tEnd = cursorInLine;
        while (tEnd < line.length && !separators.test(line[tEnd]) && line[tEnd] !== ')') tEnd++;

        const tokenPrefix = line.substring(tStart, cursorInLine); // match against this
        const fullTokenLen = tEnd - tStart; // replace this length

        // Filter
        const matches = candidates.filter(c => c.toUpperCase().startsWith(tokenPrefix.toUpperCase()));
        if (matches.length === 0) { acList.style.display = 'none'; return; }

        // Position
        const lh = 21; 
        const linesBefore = text.substring(0, lineStart + tStart).split('\n');
        const top = (linesBefore.length * lh) - inputEl.scrollTop; 
        const lastLineText = linesBefore[linesBefore.length - 1];
        const left = lastLineText.length * 8.4 + 10; 

        acList.innerHTML = '';
        matches.forEach(c => {
            const div = document.createElement('div');
            div.className = 'ac-item';
            div.innerHTML = `<span class="ac-match">${c.substring(0, tokenPrefix.length)}</span>${c.substring(tokenPrefix.length)}` + (isLabel ? '<span class="ac-type">Label</span>' : '');
            div.onmousedown = (e) => { 
                e.preventDefault(); 
                applyAc(c, lineStart + tStart, fullTokenLen); 
            };
            acList.appendChild(div);
        });

        acList.style.display = 'block';
        acList.style.top = (top + 5) + 'px';
        acList.style.left = left + 'px';
    }

    function applyAc(val, start, len) {
        const old = inputEl.value;
        inputEl.value = old.substring(0, start) + val + old.substring(start + len);
        inputEl.selectionStart = inputEl.selectionEnd = start + val.length;
        acList.style.display = 'none';
        analyzeCode();
        inputEl.focus();
    }

    function handleKey(e) {
        if (acList.style.display === 'block') {
            if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                acList.firstElementChild.onmousedown({preventDefault:()=>{}});
            } else if (e.key === 'Escape') {
                acList.style.display = 'none';
            }
        } else {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertText("    ");
            }
        }
    }

    // --- Utils ---
    function insertText(t) {
        const s = inputEl.selectionStart;
        const e = inputEl.selectionEnd;
        inputEl.value = inputEl.value.substring(0,s) + t + inputEl.value.substring(e);
        inputEl.selectionStart = inputEl.selectionEnd = s + t.length;
        inputEl.focus();
        analyzeCode();
    }

    function saveFile() {
        const b = new Blob([inputEl.value], {type:"text/plain"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = "script.txt";
        a.click();
    }

    function toggleErrors() {
        document.body.classList.toggle('show-errors', document.getElementById('chk-errors').checked);
    }

    document.getElementById('file-input').addEventListener('change', (e) => {
        if(e.target.files[0]) {
            const r = new FileReader();
            r.onload = (ev) => { inputEl.value = ev.target.result; analyzeCode(); };
            r.readAsText(e.target.files[0]);
        }
    });

    // --- Info Pane ---
    function switchTab(id) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
        document.getElementById(id).classList.add('active');
        if(id === 'flowchart') updateFlowchart();
    }

    function updateStructureTab() {
        const ll = document.getElementById('label-list');
        const vl = document.getElementById('var-list');
        ll.innerHTML = ''; vl.innerHTML = '';
        definedLabels.forEach((ln, nm) => {
            const d = document.createElement('div'); d.className='struct-item';
            d.innerHTML=`<span class="struct-name">${nm}</span><span>L${ln}</span>`;
            d.onclick=()=>jumpTo(ln); ll.appendChild(d);
        });
        definedVars.forEach((ln, nm) => {
            const d = document.createElement('div'); d.className='struct-item';
            d.innerHTML=`<span class="struct-name">${nm}</span><span>Def: L${ln}</span>`;
            d.onclick=()=>jumpTo(ln); vl.appendChild(d);
        });
    }

    function jumpTo(ln) {
        inputEl.scrollTop = (ln - 5) * 21;
    }

    function updateFlowchart() {
        const con = document.getElementById('mermaid-container');
        con.innerHTML = 'Loading...';
        let g = "graph TD;\n";
        let cid = "START"; let clbl = "START";
        let nodes = [];
        
        scriptLines.forEach((line, i) => {
            const t = line.trim();
            if (!t || t.startsWith('#') || t.toUpperCase().startsWith('REM')) return;
            if (t.toUpperCase().startsWith("LABEL")) {
                const l = t.split(/\s+/)[1];
                if (clbl) nodes.push({id:cid, lbl:clbl, next:l});
                cid = l; clbl = l + "\n";
                return;
            }
            if (t.toUpperCase().startsWith("GOTO")) {
                nodes.push({id:cid, lbl:clbl+"GOTO "+t.split(/\s+/)[1], jump:t.split(/\s+/)[1]});
                cid="N"+i; clbl=""; return;
            }
            if (t.toUpperCase().startsWith("IF")) {
                const idx = t.toUpperCase().indexOf("GOTO");
                if(idx!==-1) {
                    nodes.push({id:cid, lbl:clbl+"IF "+t.substring(2,idx).trim(), jump:t.substring(idx+4).trim(), next:"N"+i});
                    cid="N"+i; clbl=""; return;
                }
            }
            if(t.toUpperCase()=="END" || t.toUpperCase()=="RETURN") {
                nodes.push({id:cid, lbl:clbl+t}); cid="N"+i; clbl=""; return;
            }
            clbl += t.replace(/[()"]/g,'') + "\n";
        });
        if(clbl) nodes.push({id:cid, lbl:clbl});

        nodes.forEach(n => {
            if(!n.lbl.trim()) return;
            let txt = n.lbl.trim().replace(/\n/g, '<br>');
            g += `    ${n.id}["${txt}"]\n`;
            if(n.jump) g += `    ${n.id} --> ${n.jump}\n`;
            if(n.next) g += `    ${n.id} --> ${n.next}\n`;
        });

        try { mermaid.render('graphDiv', g).then(r => con.innerHTML = r.svg); } catch(e){ con.innerHTML="Error"; }
    }

    // Help Modal
    function openHelp() { document.getElementById('help-modal').style.display = 'block'; }
    function closeHelp() { document.getElementById('help-modal').style.display = 'none'; }
    window.onclick = function(event) {
        if (event.target == modal) closeHelp();
    }

    analyzeCode();
</script>
</body>
</html>