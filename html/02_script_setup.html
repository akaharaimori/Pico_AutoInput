<script>
    // --- Logic Constants ---
    const COMMANDS = [
        "LABEL", "GOTO", "IF", "GOSUB", "RETURN", "WAIT", "END",
        "SET", "PRINT", "DEBUG", "REM",
        "Mode", "UseLED", "SetLED",
        "KeyPress", "KeyRelease", "KeyPushFor", "KeyType",
        "MouseMove", "MousePress", "MouseRelease", "MousePushFor", "Mouserun",
        "ProConPress", "ProConRelease", "ProConPushFor", "ProConHat", "ProConJoy"
    ];

    const BUILTIN_FUNCS = new Set([
        "ispressed", "rand", "gettime",
        "abs", "acos", "asin", "atan", "atan2", "ceil", "clamp", "cos", "cosh", "cot", 
        "deg2rad", "e", "exp", "floor", "ln", "log10", "max", "min", "mod", "pi", 
        "pow", "power", "rad2deg", "round", "sign", "sin", "sinh", "sqr", "sqrt", 
        "sum", "tan", "tanh", "trunc", "fac", "fact", "ncr", "npr", "permut", "combin",
        "if", "ifs", "not", "and", "or", "true", "false", "nan", "even", "odd",
        "iseven", "isodd", "isnan", "iserr", "effect", "nominal"
    ]);

    const AC_CONSTANTS = {
        "MousePress": ["LEFT", "RIGHT", "MIDDLE"],
        "MouseRelease": ["LEFT", "RIGHT", "MIDDLE"],
        "MousePushFor": ["LEFT", "RIGHT", "MIDDLE"],
        "Mode": ["KeyMouse", "ProController"],
        "ProConPress": ["A", "B", "X", "Y", "L", "R", "ZL", "ZR", "MINUS", "PLUS", "HOME", "CAPTURE", "LCLICK", "RCLICK", "UP", "DOWN", "LEFT", "RIGHT"],
        "ProConRelease": ["A", "B", "X", "Y", "L", "R", "ZL", "ZR", "MINUS", "PLUS", "HOME", "CAPTURE", "LCLICK", "RCLICK"],
        "ProConPushFor": ["A", "B", "X", "Y", "L", "R", "ZL", "ZR", "MINUS", "PLUS", "HOME", "CAPTURE", "LCLICK", "RCLICK"],
        "ProConHat": ["UP", "UP_RIGHT", "RIGHT", "RIGHT_DOWN", "DOWN", "DOWN_LEFT", "LEFT", "LEFT_UP", "CENTER"],
        "KeyPress": ["ENTER", "SPACE", "ESC", "TAB", "BACKSPACE", "CAPSLOCK", "UP", "DOWN", "LEFT", "RIGHT", "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F11", "F12"],
        "KeyRelease": ["ENTER", "SPACE", "ESC", "TAB", "BACKSPACE", "UP", "DOWN", "LEFT", "RIGHT"],
        "KeyPushFor": ["ENTER", "SPACE", "ESC", "TAB", "BACKSPACE", "UP", "DOWN", "LEFT", "RIGHT"]
    };
    
    const VALID_CONSTANTS = new Set(Object.values(AC_CONSTANTS).flat().map(s => s.toUpperCase()));

    // --- DOM Elements ---
    const inputEl = document.getElementById('code-input');
    const highlightEl = document.getElementById('code-highlight');
    const acList = document.getElementById('autocomplete-list');
    const modal = document.getElementById('help-modal');
    
    // --- State ---
    let definedLabels = new Map();
    let definedVars = new Map();
    let scriptLines = [];
    // For paren matching
    let matchedParenIndices = new Set(); 

    // --- Init ---
    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    // Event Listeners
    inputEl.addEventListener('input', () => { analyzeCode(); checkAutocomplete(); updateParenMatch(); });
    inputEl.addEventListener('scroll', () => {
        highlightEl.scrollTop = inputEl.scrollTop;
        highlightEl.scrollLeft = inputEl.scrollLeft;
    });
    inputEl.addEventListener('keydown', handleKey);
    inputEl.addEventListener('click', () => { checkAutocomplete(); updateParenMatch(); });
    inputEl.addEventListener('keyup', () => { updateParenMatch(); });
    inputEl.addEventListener('blur', () => { setTimeout(() => acList.style.display = 'none', 200); });
    
    // Show help on startup
    window.onload = () => { 
        analyzeCode(); 
        openHelp(); 
    };

